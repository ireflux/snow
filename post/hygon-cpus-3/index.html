<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="最重要的问题是与标准 Ryzen 和 EPYC CPU 相比，这些处理器究竟发生了什么变化。有人怀疑它们是重新贴了个标签的 AMD 处理器，这是完全不对的——我们可以通过 Linux 内核更新提供的不同加密引擎来反驳这一点。而且我们还发现了其他差异。
从总体上来看，我们可以确定，核心布局是相同的，缓存大小，TLB(Translation Lookaside Buffer 转换后备缓冲区) 大小和端口分配都相同——在此基础级别上没有差异。海光 CPU 仍然为 L1 高速指令缓存提供64 KB 4路，为 L1 高速数据缓存提供32 KB 8路，为 L2 高速缓存提供512 KB 8路，为 L3 高速缓存提供8 MB 16路。这些和 Zen 1 核心是相同的。 转换后备缓冲区条目如下：
"><title>「译文」| 海光 CPU：中版的加密方式，不同的性能(三)</title><link rel=canonical href=https://ireflux.github.io/snow/post/hygon-cpus-3/><link rel=stylesheet href=/snow/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property="og:title" content="「译文」| 海光 CPU：中版的加密方式，不同的性能(三)"><meta property="og:description" content="最重要的问题是与标准 Ryzen 和 EPYC CPU 相比，这些处理器究竟发生了什么变化。有人怀疑它们是重新贴了个标签的 AMD 处理器，这是完全不对的——我们可以通过 Linux 内核更新提供的不同加密引擎来反驳这一点。而且我们还发现了其他差异。
从总体上来看，我们可以确定，核心布局是相同的，缓存大小，TLB(Translation Lookaside Buffer 转换后备缓冲区) 大小和端口分配都相同——在此基础级别上没有差异。海光 CPU 仍然为 L1 高速指令缓存提供64 KB 4路，为 L1 高速数据缓存提供32 KB 8路，为 L2 高速缓存提供512 KB 8路，为 L3 高速缓存提供8 MB 16路。这些和 Zen 1 核心是相同的。 转换后备缓冲区条目如下：
"><meta property="og:url" content="https://ireflux.github.io/snow/post/hygon-cpus-3/"><meta property="og:site_name" content="sherry's blog"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="测试中国的 x86 CPU"><meta property="article:published_time" content="2020-06-11T00:00:00+00:00"><meta property="article:modified_time" content="2020-06-11T00:00:00+00:00"><meta name=twitter:title content="「译文」| 海光 CPU：中版的加密方式，不同的性能(三)"><meta name=twitter:description content="最重要的问题是与标准 Ryzen 和 EPYC CPU 相比，这些处理器究竟发生了什么变化。有人怀疑它们是重新贴了个标签的 AMD 处理器，这是完全不对的——我们可以通过 Linux 内核更新提供的不同加密引擎来反驳这一点。而且我们还发现了其他差异。
从总体上来看，我们可以确定，核心布局是相同的，缓存大小，TLB(Translation Lookaside Buffer 转换后备缓冲区) 大小和端口分配都相同——在此基础级别上没有差异。海光 CPU 仍然为 L1 高速指令缓存提供64 KB 4路，为 L1 高速数据缓存提供32 KB 8路，为 L2 高速缓存提供512 KB 8路，为 L3 高速缓存提供8 MB 16路。这些和 Zen 1 核心是相同的。 转换后备缓冲区条目如下：
"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/snow><img src=/snow/img/avatar_huda2458f72ce188392d75c5d51cd8e24e_373_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/snow>sherry's blog</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li><a href=/snow/><span>Home</span></a></li><li><a href=/snow/post/><span>Archives</span></a></li><li><a href=/snow/tags/><span>Tags</span></a></li><li><a href=/snow/categories/><span>Categories</span></a></li><li><a href=/snow/about/><span>About</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/snow/categories/to-the-new-world/>To The New World</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/snow/post/hygon-cpus-3/>「译文」| 海光 CPU：中版的加密方式，不同的性能(三)</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jun 11, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>2 minute read</time></div></footer></div></header><section class=article-content><p>最重要的问题是与标准 Ryzen 和 EPYC CPU 相比，这些处理器究竟发生了什么变化。有人怀疑它们是重新贴了个标签的 AMD 处理器，这是完全不对的——我们可以通过 Linux 内核更新提供的不同加密引擎来反驳这一点。而且我们还发现了其他差异。</p><p>从总体上来看，我们可以确定，核心布局是相同的，缓存大小，<a class=link href=https://en.wikipedia.org/wiki/Translation_lookaside_buffer target=_blank rel=noopener>TLB(Translation Lookaside Buffer 转换后备缓冲区)</a> 大小和端口分配都相同——在此基础级别上没有差异。海光 CPU 仍然为 L1 高速指令缓存提供64 KB 4路，为 L1 高速数据缓存提供32 KB 8路，为 L2 高速缓存提供512 KB 8路，为 L3 高速缓存提供8 MB 16路。这些和 Zen 1 核心是相同的。 转换后备缓冲区条目如下：</p><ul><li>L1D + L1I: 4K/2M/1G 64-entry</li><li>L2D: 4K 1536-entry 6-way, 2M 1536-entry 3-way, no 1G</li><li>L2I: 4K/2M 1024-entry 8-way, no 1G</li></ul><p>L1 的内存访问时间为4个周期，L2 的为12个周期，L3 的为37-40个周期。记忆潜伏期在284-307个周期内测量。</p><p>L1 读取速度的测量约为每个时钟32个字节（总计805 GB/s，每个内核约100 GB/s），而写入速度测量的每个时钟约为16个字节（总计408 GB/s，每个内核约51 GB/s） ）。 8核的 DDR4 内存速度使读取速度为38.5 GB/s，写入速度为35.8 GB/s。</p><h2 id=加密上的变化>加密上的变化</h2><p>对于加密更改，Linux 内核更新中详细介绍了这些更改。更新围绕 AMD 的虚拟化功能或 <a class=link href=https://en.wikipedia.org/wiki/Zen_%28first_generation_microarchitecture%29#Enhanced_security_and_virtualization_support target=_blank rel=noopener>SEV(Secure Encrypted Virtualization 安全加密虚拟化)</a> 的安全加密进行。通常，对于 EPYC 处理器，SEV 由 AMD 定义的加密协议控制，在这种情况下为 <a class=link href=https://en.wikipedia.org/wiki/RSA_%28cryptosystem%29 target=_blank rel=noopener>RSA(Rivest–Shamir–Adleman)</a>，<a class=link href=https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm target=_blank rel=noopener>ECDSA(Elliptic Curve Digital Signature Algorithm)</a>，<a class=link href=https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman target=_blank rel=noopener>ECDH(Elliptic-curve Diffie–Hellman)</a>，<a class=link href=https://en.wikipedia.org/wiki/Secure_Hash_Algorithms target=_blank rel=noopener>SHA(Secure Hash Algorithms)</a> 和 <a class=link href=https://en.wikipedia.org/wiki/Advanced_Encryption_Standard target=_blank rel=noopener>AES(Advanced Encryption Standard)</a>。为了生成正确的密钥，SEV 使用这些方法。但是，在海光 Dhyana 设计中，SEV 被构建为使用称为 SM2，SM3 和 SM4 的算法。</p><p>正如更新中所述，SM2 基于椭圆曲线密码学，并且需要其他私钥/公钥交换。SM3 是类似于 SHA-256 的哈希算法，SM4 是类似于 AES-128 的分组密码算法。为了支持这些算法所需的额外功能，这些命令已加入到 Linux 内核中。说明书中指出，这些算法已在海光 Dhyana Plus（可能是大型 CPU）处理器上成功测试过，也已在 AMD 的 EPYC CPU 上成功测试过。</p><h2 id=减缓指令执行速度>减缓指令执行速度</h2><p>我们能够确定的最大设计上的变更是指令吞吐量。我们认为 Dhyana Plus 和之前提到的 EPYC 之间没什么不同，并且我们做了额外的检查以确保我们的软件能够显示正确的数据，但只是故意将某些指令放慢了他们的执行速度。这里面有一些相当严肃的含义，尤其是取决于它何时在管道中发生。</p><p>我们认为情况是，为了让 AMD 导出其 SoC 设计，海光还必须共享与 CPU 解释指令的方式有关的微代码，并且还要放慢某些关键指令的执行速度（或完全禁用），以便合资公司继续和中国合作。</p><p>在我们的测试中，我们发现，尽管海光和 EPYC 之间的整数性能相似，但某些浮点指令（即 DIV 和 SQRT 运算）并未在海光 CPU 中进行流水线处理。这意味着吞吐量和延迟减少了。许多简单的 <a class=link href=https://en.wikipedia.org/wiki/MMX_%28instruction_set%29 target=_blank rel=noopener>MMX</a> / <a class=link href=https://en.wikipedia.org/wiki/Streaming_SIMD_Extensions target=_blank rel=noopener>SSE(Streaming SIMD Extensions)</a> 指令降低了吞吐量，以下表格列出了指令吞吐量差异：</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>AnandTech</th><th style=text-align:center>EPYC Naples</th><th style=text-align:center>Hygon Dhyana</th></tr></thead><tbody><tr><td style=text-align:center>ADD/SUB</td><td style=text-align:center>2 per clock</td><td style=text-align:center>1 per clock</td></tr><tr><td style=text-align:center>CMP/MULP*</td><td style=text-align:center>2 per clock</td><td style=text-align:center>1 per clock</td></tr><tr><td style=text-align:center>ADDSUBP*</td><td style=text-align:center>2 per clock</td><td style=text-align:center>1 per clock</td></tr><tr><td style=text-align:center>RCP*/RSQRT*</td><td style=text-align:center>1 per clock</td><td style=text-align:center>0.5 per clock</td></tr><tr><td style=text-align:center>BLENDW</td><td style=text-align:center>3 per clock</td><td style=text-align:center>2 per clock</td></tr><tr><td style=text-align:center>PMIN/MAX*</td><td style=text-align:center>3 per clock</td><td style=text-align:center>2 per clcok</td></tr><tr><td style=text-align:center>PAND/ANDN/OR/XOR</td><td style=text-align:center>4 per clock</td><td style=text-align:center>2 per clock</td></tr><tr><td style=text-align:center>MOVs</td><td style=text-align:center>4 per clock</td><td style=text-align:center>2 per clock</td></tr></tbody></table></div><p>所有这些指令对于基本任务都非常重要。通过限制这些指令的并行吞吐率，这意味着这些 CPU 无法计算并行化的代码，从而降低性能。</p><p>但是，最大的变化或许是服务器版“Dhyana Plus”和消费版“Dhyana”版本之间的差异。Dhyana Plus 大大减少了随机数生成的作用。关键指令 RDRAND 和 RDSEED 具有各种导致速度变慢或变快的原因。</p><p>RDRAND 指令比较如下：</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>AnandTech</th><th style=text-align:center>Zen 1 Desktop</th><th style=text-align:center>Hygon Dhyana</th><th style=text-align:center>Hygon Dhyana Plus</th></tr></thead><tbody><tr><td style=text-align:center>16-bit</td><td style=text-align:center>1200 clocks</td><td style=text-align:center>1100 clocks</td><td style=text-align:center>800 clocks</td></tr><tr><td style=text-align:center>32-bit</td><td style=text-align:center>1200 clocks</td><td style=text-align:center>1100 clocks</td><td style=text-align:center>800 clocks</td></tr><tr><td style=text-align:center>64-bit</td><td style=text-align:center>2365 clocks</td><td style=text-align:center>2125 clocks</td><td style=text-align:center>1520 clocks</td></tr></tbody></table></div><p>RDSEED 指令比较如下：</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>AnandTech</th><th style=text-align:center>Zen 1 Desktop</th><th style=text-align:center>Hygon Dhyana</th><th style=text-align:center>Hygon Dhyana Plus</th></tr></thead><tbody><tr><td style=text-align:center>16-bit</td><td style=text-align:center>1200 clocks</td><td style=text-align:center>1100 clocks</td><td style=text-align:center>12000 clocks</td></tr><tr><td style=text-align:center>32-bit</td><td style=text-align:center>1200 clocks</td><td style=text-align:center>1100 clocks</td><td style=text-align:center>12000 clocks</td></tr><tr><td style=text-align:center>64-bit</td><td style=text-align:center>2365 clocks</td><td style=text-align:center>2125 clocks</td><td style=text-align:center>27100 clocks</td></tr></tbody></table></div><p>看上图发现差异还是很大的，尤其是在 RDSEED 中。我们看到 RDSEED（用于生成随机数算法的种子生成）在服务器芯片上的速度慢了10倍以上，而用于实际基于硬件的随机数生成 RDRAND 则比标准 Ryzen 快——在服务器芯片上也是如此。有趣的是，在 Ryzen Mobile 和 Ryzen Desktop APU 上也看到了服务器芯片的 RDSEED 相同的延迟。</p><p>对于 RDRAND 指令，拥有更快的随机数生成器可以说明两件事：要么实际上更快，要么随机算法的周期性较低。例如：指向一个自我包装的算法。最好的伪随机数生成具有最大的周期性，因此在这种情况下，很快我们就能得出 RDRAND 指令结论，周期性较低，从而导致生成质量较低的随机数。</p><p>对于 RDSEED 指令，它慢10倍的情况有点不同。RDSEED 指令从主板上的各种传感器中获取信息，并输出一个随机值来初始化 RDRAND——每个周期只能调用一次。较慢的 RDSEED 要么意味着它从更多源获取数据，要么是故意放慢了。</p><p>实际上，RDRAND 和 RDSEED 可以在我们的 Dhyana Plus 系统的 BIOS 中启用或禁用。</p><p><img src=https://s1.ax1x.com/2020/06/11/tbDBAx.jpg loading=lazy alt=img></p><p>有趣的是，此菜单称为“Moksha 通用选项”。 Moksha 通常是与“启蒙”或“释放”相关的词。这要么是一个有趣的文字游戏，要么是有人无视上下文从古汉英词典中找的词。</p><p>关于 AVX 和 AVX2 的性能，即使 CPU 标识着支持 AVX 和 AVX2，但尝试实际测量这些指令时却失败了——在我们的指令转储中，它们被列为“支持的，已禁用”。关于所支持的功能，Zen 1 通常将 AESNI，SHA，CLMUL，FMA4，BMI 和 BMI2 列为支持的指令——海光 CPU 不支持这些指令。</p><p>对于 AES 之类的东西，我们做了一个基准测试，这些 CPU 不支持 AES，意味着性能大打折扣：</p><p><img src=https://s1.ax1x.com/2020/06/11/tbDwH1.png loading=lazy alt=img></p><p>还有一点需要注意，通过探测寄存器来查找 AMD CPU 功耗的典型手段在这里也失效了。似乎完全从 CPU 中删除了。</p><p>(未完待续&mldr;)</p><h2 id=其他篇章>其他篇章</h2><ol><li><a class=link href=https://sherry.ml/snow/post/hygon-cpus-1/ target=_blank rel=noopener>「译文」| 测试中国的 x86 CPU：深入研究基于 Zen 的 Hygon Dhyana 处理器(一)</a></li><li><a class=link href=https://sherry.ml/snow/post/hygon-cpus-2/ target=_blank rel=noopener>「译文」| 我们的海光系统：8核 Dhyana 和双32核 Dhyana Plus(二)</a></li><li><a class=link href=https://sherry.ml/snow/post/hygon-cpus-4/ target=_blank rel=noopener>「译文」| 基准测试：Windows(四)</a></li><li><a class=link href=https://sherry.ml/snow/post/hygon-cpus-5/ target=_blank rel=noopener>「译文」| 结论(五)</a></li></ol></section><footer class=article-footer><section class=article-tags><a href=/snow/tags/%E6%B5%8B%E8%AF%95%E4%B8%AD%E5%9B%BD%E7%9A%84-x86-cpu/>测试中国的 x86 CPU</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/snow/post/hygon-cpus-2/><div class=article-details><h2 class=article-title>「译文」| 我们的海光系统：8核 Dhyana 和双32核 Dhyana Plus(二)</h2></div></a></article><article><a href=/snow/post/hygon-cpus-1/><div class=article-details><h2 class=article-title>「译文」| 测试中国的 x86 CPU：深入研究基于 Zen 的海光 Dhyana 处理器(一)</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2023 sherry's blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/snow/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>